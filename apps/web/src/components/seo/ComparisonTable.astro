---
/**
 * ComparisonTable - "Us vs Them" competitive comparison (GEO 2025)
 *
 * Research shows: 32% of AI citations come from comparison tables
 * - Semantic table markup with proper scope attributes
 * - Schema.org ComparisonTable structured data
 * - Visual indicators (green checkmarks, red X marks)
 * - Clear differentiators (Privacy, Price, Limits, Quality)
 *
 * Usage:
 * <ComparisonTable
 *   toolName="PDF Merge"
 *   competitors={[
 *     { name: "SmallPDF", features: { price: "$12/month", privacy: "Cloud upload", ... } },
 *     { name: "iLovePDF", features: { price: "$7/month", privacy: "Cloud upload", ... } }
 *   ]}
 *   ourFeatures={{ price: "Free forever", privacy: "100% local", ... }}
 * />
 */

interface CompetitorFeatures {
  price: string | boolean;
  privacy: string | boolean;
  accountRequired: string | boolean;
  usageLimits: string | boolean;
  watermarks: string | boolean;
  worksOffline: string | boolean;
  [key: string]: string | boolean; // Allow custom features
}

interface Competitor {
  name: string;
  features: CompetitorFeatures;
}

interface Props {
  toolName: string;
  competitors: Competitor[];
  ourFeatures: CompetitorFeatures;
  customFeatures?: { key: string; label: string }[]; // Optional custom feature labels
}

const {
  toolName,
  competitors,
  ourFeatures,
  customFeatures = []
} = Astro.props;

// Standard feature set with display labels
const standardFeatures = [
  { key: 'price', label: 'Price' },
  { key: 'privacy', label: 'Privacy' },
  { key: 'accountRequired', label: 'Account Required' },
  { key: 'usageLimits', label: 'Usage Limits' },
  { key: 'watermarks', label: 'Watermarks' },
  { key: 'worksOffline', label: 'Works Offline' }
];

// Merge with custom features if provided
const allFeatures = [...standardFeatures, ...customFeatures];

// Determine if a feature is an advantage (green) or disadvantage (red)
const isAdvantage = (value: string | boolean, featureKey: string): boolean => {
  if (typeof value === 'boolean') return value;

  const lowerValue = String(value).toLowerCase();

  // Price: Free is good, $ is bad
  if (featureKey === 'price') {
    return lowerValue.includes('free');
  }

  // Privacy: Local is good, cloud/upload is bad
  if (featureKey === 'privacy') {
    return lowerValue.includes('local') || lowerValue.includes('browser');
  }

  // Account Required: No is good, Yes is bad
  if (featureKey === 'accountRequired') {
    return lowerValue === 'no' || lowerValue === 'false';
  }

  // Usage Limits: Unlimited is good, limits are bad
  if (featureKey === 'usageLimits') {
    return lowerValue.includes('unlimited') || lowerValue === 'none';
  }

  // Watermarks: None is good, Yes is bad
  if (featureKey === 'watermarks') {
    return lowerValue === 'none' || lowerValue === 'no' || lowerValue === 'false';
  }

  // Works Offline: Yes is good, No is bad
  if (featureKey === 'worksOffline') {
    return lowerValue === 'yes' || lowerValue === 'true';
  }

  return false;
};

// Format cell content with visual indicators
const formatCell = (value: string | boolean, isOurTool: boolean, featureKey: string) => {
  const isGood = isAdvantage(value, featureKey);
  const displayValue = typeof value === 'boolean' ? (value ? 'Yes' : 'No') : value;

  return {
    value: displayValue,
    isGood,
    icon: isGood ? 'check' : 'x'
  };
};

// Generate schema.org ComparisonTable structured data
const schemaData = {
  "@context": "https://schema.org",
  "@type": "Table",
  "about": {
    "@type": "SoftwareApplication",
    "name": toolName,
    "applicationCategory": "UtilityApplication"
  },
  "description": `Comparison of ${toolName} vs competitors`,
  "dateModified": new Date().toISOString()
};
---

<section
  class="comparison-section"
  aria-labelledby="comparison-heading"
  data-ai-citation="true"
  data-comparison-table="true"
>
  <!-- Schema.org structured data -->
  <script type="application/ld+json" set:html={JSON.stringify(schemaData)} />

  <h2 id="comparison-heading" class="comparison-heading">
    How Does {toolName} Compare?
  </h2>

  <p class="comparison-intro">
    We built {toolName} to be completely free and private. Here's how we stack up against popular alternatives:
  </p>

  <div class="table-wrapper">
    <table
      class="comparison-table"
      role="table"
      aria-label={`Comparison of ${toolName} with competitors`}
    >
      <thead>
        <tr>
          <th scope="col" class="feature-col">Feature</th>
          <th scope="col" class="our-col">
            <div class="our-brand">
              {toolName}
              <span class="our-badge">Us</span>
            </div>
          </th>
          {competitors.map(competitor => (
            <th scope="col" class="competitor-col">
              {competitor.name}
            </th>
          ))}
        </tr>
      </thead>
      <tbody>
        {allFeatures.map(({ key, label }) => {
          const ourCell = formatCell(ourFeatures[key], true, key);

          return (
            <tr>
              <th scope="row" class="feature-label">{label}</th>
              <td class={`our-cell ${ourCell.isGood ? 'advantage' : 'disadvantage'}`}>
                <span class="cell-content">
                  {ourCell.icon === 'check' ? (
                    <svg class="icon icon-check" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                      <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                    </svg>
                  ) : (
                    <svg class="icon icon-x" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                      <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                    </svg>
                  )}
                  <span class="cell-text">{ourCell.value}</span>
                </span>
              </td>
              {competitors.map(competitor => {
                const compCell = formatCell(competitor.features[key], false, key);
                return (
                  <td class={`competitor-cell ${compCell.isGood ? 'advantage' : 'disadvantage'}`}>
                    <span class="cell-content">
                      {compCell.icon === 'check' ? (
                        <svg class="icon icon-check" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                          <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                      ) : (
                        <svg class="icon icon-x" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                          <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                        </svg>
                      )}
                      <span class="cell-text">{compCell.value}</span>
                    </span>
                  </td>
                );
              })}
            </tr>
          );
        })}
      </tbody>
    </table>
  </div>

  <p class="comparison-footer">
    All data accurate as of {new Date().toLocaleDateString('en-US', { month: 'long', year: 'numeric' })}.
    Competitor pricing and features may change.
  </p>
</section>

<style>
  .comparison-section {
    margin: 3rem 0;
    padding: 2rem;
    border: 1px solid var(--border);
    background: linear-gradient(
      135deg,
      rgba(255, 255, 255, 0.01) 0%,
      rgba(255, 255, 255, 0.03) 100%
    );
  }

  .comparison-heading {
    font-size: 1.125rem;
    font-weight: 400;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    margin-bottom: 1rem;
    color: var(--text);
    text-align: center;
  }

  .comparison-intro {
    font-size: 0.875rem;
    line-height: 1.6;
    color: var(--text-dim);
    text-align: center;
    max-width: 42rem;
    margin: 0 auto 2rem;
  }

  .table-wrapper {
    overflow-x: auto;
    border: 1px solid var(--border);
    background: var(--bg-card);
  }

  .comparison-table {
    width: 100%;
    border-collapse: collapse;
    font-family: var(--font-mono);
    font-size: 0.8125rem;
  }

  /* Header */
  .comparison-table thead {
    background: var(--bg-secondary);
    border-bottom: 2px solid var(--border-accent);
  }

  .comparison-table thead th {
    padding: 1rem 0.75rem;
    text-align: left;
    font-weight: 500;
    letter-spacing: 0.05em;
    text-transform: uppercase;
    font-size: 0.6875rem;
  }

  .feature-col {
    color: var(--text-muted);
    min-width: 140px;
  }

  .our-col {
    background: rgba(34, 197, 94, 0.05);
    border-left: 2px solid #22c55e;
    border-right: 2px solid #22c55e;
    min-width: 160px;
  }

  .our-brand {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
    color: var(--text);
  }

  .our-badge {
    display: inline-block;
    padding: 0.125rem 0.5rem;
    background: #22c55e;
    color: #0a0a0a;
    font-size: 0.625rem;
    letter-spacing: 0.1em;
    font-weight: 600;
    border-radius: 2px;
    width: fit-content;
  }

  .competitor-col {
    color: var(--text-dim);
    min-width: 140px;
  }

  /* Body */
  .comparison-table tbody tr {
    border-bottom: 1px solid var(--border);
    transition: background var(--transition);
  }

  .comparison-table tbody tr:hover {
    background: rgba(255, 255, 255, 0.02);
  }

  .feature-label {
    padding: 0.875rem 0.75rem;
    font-weight: 400;
    color: var(--text-dim);
    text-align: left;
    font-size: 0.75rem;
    letter-spacing: 0.05em;
  }

  /* Cells */
  .comparison-table td {
    padding: 0.875rem 0.75rem;
    vertical-align: middle;
  }

  .our-cell {
    background: rgba(34, 197, 94, 0.03);
    border-left: 2px solid rgba(34, 197, 94, 0.3);
    border-right: 2px solid rgba(34, 197, 94, 0.3);
  }

  .cell-content {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .icon {
    width: 1rem;
    height: 1rem;
    flex-shrink: 0;
  }

  .icon-check {
    color: #22c55e;
  }

  .icon-x {
    color: #ef4444;
  }

  .cell-text {
    font-size: 0.75rem;
    letter-spacing: 0.03em;
  }

  /* Advantage/Disadvantage styling */
  .advantage .cell-text {
    color: var(--text);
    font-weight: 500;
  }

  .disadvantage .cell-text {
    color: var(--text-muted);
  }

  /* Highlight our advantages */
  .our-cell.advantage {
    background: rgba(34, 197, 94, 0.08);
  }

  .our-cell.advantage .cell-text {
    color: #22c55e;
    font-weight: 600;
  }

  /* Footer */
  .comparison-footer {
    margin-top: 1rem;
    font-size: 0.6875rem;
    color: var(--text-muted);
    text-align: center;
    letter-spacing: 0.05em;
  }

  /* Responsive */
  @media (max-width: 768px) {
    .comparison-section {
      padding: 1.5rem 1rem;
    }

    .table-wrapper {
      margin: 0 -1rem;
      border-left: none;
      border-right: none;
    }

    .comparison-table {
      font-size: 0.75rem;
    }

    .comparison-table thead th,
    .comparison-table td {
      padding: 0.75rem 0.5rem;
    }

    .feature-col,
    .our-col,
    .competitor-col {
      min-width: 120px;
    }

    .cell-content {
      flex-direction: column;
      align-items: flex-start;
      gap: 0.25rem;
    }
  }

  /* Print optimization */
  @media print {
    .comparison-section {
      break-inside: avoid;
      page-break-inside: avoid;
    }

    .comparison-table {
      border: 1px solid #000;
    }

    .icon-check {
      color: #000;
    }

    .icon-x {
      color: #666;
    }
  }
</style>
