name: Optimized CI/CD Pipeline

on:
  push:
    branches: [ main, master, develop, 'feat/**', 'fix/**' ]
  pull_request:
    branches: [ main, master, develop ]
  workflow_dispatch:
    inputs:
      run_all_tests:
        description: 'Force run all tests (ignore affected detection)'
        required: false
        default: false
        type: boolean
      skip_visual_tests:
        description: 'Skip visual regression tests'
        required: false
        default: false
        type: boolean

env:
  NODE_VERSION: '20'
  PLAYWRIGHT_VERSION: '1.57.0'
  CACHE_VERSION: 'v1'

jobs:
  # Job 1: Detect changes and setup
  changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      web-changed: ${{ steps.filter.outputs.web }}
      tests-changed: ${{ steps.filter.outputs.tests }}
      docs-changed: ${{ steps.filter.outputs.docs }}
      affected-tests: ${{ steps.affected-tests.outputs.tests }}
      should-skip-visual: ${{ steps.visual-check.outputs.skip }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Paths Filter
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            web:
              - 'apps/web/**'
              - 'packages/**'
              - 'package.json'
              - 'package-lock.json'
            tests:
              - 'apps/web/tests/**'
              - 'apps/web/playwright.config.ts'
            docs:
              - 'docs/**'
              - '**/*.md'

      - name: Detect Affected Tests
        id: affected-tests
        if: steps.filter.outputs.web == 'true' || steps.filter.outputs.tests == 'true'
        run: |
          # Get changed files
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -E '\.(ts|tsx|js|jsx|astro)$' || true)
          else
            CHANGED_FILES=$(git diff --name-only HEAD~1...HEAD | grep -E '\.(ts|tsx|js|jsx|astro)$' || true)
          fi

          # Map changed files to test files
          AFFECTED_TESTS=""
          for file in $CHANGED_FILES; do
            # Convert source file to potential test file
            TEST_FILE=$(echo "$file" | sed 's|apps/web/src/|apps/web/tests/|' | sed 's|\.(ts|tsx|js|jsx|astro)$|.spec.ts|')
            if [ -f "$TEST_FILE" ]; then
              AFFECTED_TESTS="$AFFECTED_TESTS $TEST_FILE"
            fi
          done

          # Also include tests that import changed files
          if [ -n "$CHANGED_FILES" ]; then
            IMPORTED_TESTS=$(grep -r "import.*from.*["'$CHANGED_FILES'"]" apps/web/tests/ -l | tr '\n' ' ' || true)
            AFFECTED_TESTS="$AFFECTED_TESTS $IMPORTED_TESTS"
          fi

          # Default to all tests if we can't determine affected tests
          if [ -z "$AFFECTED_TESTS" ] || [ "${{ github.event.inputs.run_all_tests }}" = "true" ]; then
            echo "tests=all" >> $GITHUB_OUTPUT
          else
            echo "tests=$AFFECTED_TESTS" >> $GITHUB_OUTPUT
          fi

      - name: Check Visual Test Skip
        id: visual-check
        run: |
          # Skip visual tests for docs-only changes or when explicitly skipped
          if [ "${{ steps.filter.outputs.docs }}" = "true" ] && [ "${{ steps.filter.outputs.web }}" != "true" ] && [ "${{ steps.filter.outputs.tests }}" != "true" ]; then
            echo "skip=true" >> $GITHUB_OUTPUT
          elif [ "${{ github.event.inputs.skip_visual_tests }}" = "true" ]; then
            echo "skip=true" >> $GITHUB_OUTPUT
          else
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

  # Job 2: Build and Cache Dependencies
  build:
    name: Build Application
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.web-changed == 'true' || needs.changes.outputs.tests-changed == 'true'
    outputs:
      build-hash: ${{ steps.build-cache.outputs.hash }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Cache Node Modules
        id: npm-cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.npm
            apps/web/node_modules
            node_modules
          key: ${{ runner.os }}-node-${{ env.CACHE_VERSION }}-${{ hashFiles('package-lock.json', 'apps/web/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-${{ env.CACHE_VERSION }}-

      - name: Cache Build Output
        id: build-cache
        uses: actions/cache@v4
        with:
          path: apps/web/dist
          key: ${{ runner.os }}-build-${{ env.CACHE_VERSION }}-${{ hashFiles('apps/web/**', 'packages/**', 'package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-build-${{ env.CACHE_VERSION }}-

      - name: Install Dependencies
        if: steps.npm-cache.outputs.cache-hit != 'true'
        run: |
          npm ci
          npm run install:all

      - name: Build Application
        if: steps.build-cache.outputs.cache-hit != 'true'
        run: |
          npm run build
          echo "hash=${{ hashFiles('apps/web/dist/**') }}" >> $GITHUB_OUTPUT

      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-output
          path: apps/web/dist
          retention-days: 1

  # Job 3: Install Playwright Browsers (Cached)
  playwright-deps:
    name: Install Playwright
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.tests-changed == 'true' || needs.changes.outputs.web-changed == 'true'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Cache Playwright
        id: playwright-cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/ms-playwright
            ~/Library/Caches/ms-playwright
            ~/AppData/Local/ms-playwright
          key: ${{ runner.os }}-playwright-${{ env.CACHE_VERSION }}-${{ env.PLAYWRIGHT_VERSION }}

      - name: Install Dependencies
        run: |
          npm ci
          npm run install:all

      - name: Install Playwright Browsers
        if: steps.playwright-cache.outputs.cache-hit != 'true'
        run: npx playwright install --with-deps

  # Job 4: Type Check and Lint
  quality-check:
    name: Code Quality
    runs-on: ubuntu-latest
    needs: [changes, build]
    if: needs.changes.outputs.web-changed == 'true'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Restore Node Modules Cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.npm
            apps/web/node_modules
            node_modules
          key: ${{ runner.os }}-node-${{ env.CACHE_VERSION }}-${{ hashFiles('package-lock.json', 'apps/web/package-lock.json') }}

      - name: Type Check
        run: npm run check

      - name: Security Audit
        run: |
          npm audit --audit-level=high
          cd apps/web && npm audit --audit-level=high

  # Job 5: Unit Tests (Fast)
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: [changes, build]
    if: needs.changes.outputs.web-changed == 'true'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Restore Node Modules Cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.npm
            apps/web/node_modules
            node_modules
          key: ${{ runner.os }}-node-${{ env.CACHE_VERSION }}-${{ hashFiles('package-lock.json', 'apps/web/package-lock.json') }}

      - name: Run Unit Tests
        run: |
          # Add unit test commands when available
          echo "Unit tests would run here"

  # Job 6: E2E Tests (Sharded)
  e2e-tests:
    name: E2E Tests Shard ${{ matrix.shard }}
    runs-on: ubuntu-latest
    needs: [changes, build, playwright-deps]
    if: needs.changes.outputs.tests-changed == 'true' || needs.changes.outputs.web-changed == 'true'
    strategy:
      fail-fast: false
      matrix:
        shard: [1, 2, 3, 4]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Restore Node Modules Cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.npm
            apps/web/node_modules
            node_modules
          key: ${{ runner.os }}-node-${{ env.CACHE_VERSION }}-${{ hashFiles('package-lock.json', 'apps/web/package-lock.json') }}

      - name: Restore Playwright Cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/ms-playwright
            ~/Library/Caches/ms-playwright
            ~/AppData/Local/ms-playwright
          key: ${{ runner.os }}-playwright-${{ env.CACHE_VERSION }}-${{ env.PLAYWRIGHT_VERSION }}

      - name: Download Build Artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-output
          path: apps/web/dist

      - name: Run E2E Tests (Shard ${{ matrix.shard }})
        run: |
          cd apps/web
          if [ "${{ needs.changes.outputs.affected-tests }}" = "all" ]; then
            npm run test:shard:${{ matrix.shard }}
          else
            # Run only affected tests in this shard
            npx playwright test ${{ needs.changes.outputs.affected-tests }} --shard=${{ matrix.shard }}/4 --project=chromium
          fi

      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-shard-${{ matrix.shard }}
          path: |
            apps/web/test-results/
            apps/web/playwright-report/
          retention-days: 7

  # Job 7: Visual Regression Tests
  visual-tests:
    name: Visual Regression Tests
    runs-on: ubuntu-latest
    needs: [changes, build, playwright-deps]
    if: |
      needs.changes.outputs.web-changed == 'true' &&
      needs.changes.outputs.should-skip-visual != 'true' &&
      (github.event_name == 'pull_request' || github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Restore Node Modules Cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.npm
            apps/web/node_modules
            node_modules
          key: ${{ runner.os }}-node-${{ env.CACHE_VERSION }}-${{ hashFiles('package-lock.json', 'apps/web/package-lock.json') }}

      - name: Restore Playwright Cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/ms-playwright
            ~/Library/Caches/ms-playwright
            ~/AppData/Local/ms-playwright
          key: ${{ runner.os }}-playwright-${{ env.CACHE_VERSION }}-${{ env.PLAYWRIGHT_VERSION }}

      - name: Download Build Artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-output
          path: apps/web/dist

      - name: Check for Visual Baselines
        id: visual-baseline
        run: |
          if [ -d "apps/web/tests/__screenshots__" ]; then
            echo "has-baseline=true" >> $GITHUB_OUTPUT
          else
            echo "has-baseline=false" >> $GITHUB_OUTPUT
          fi

      - name: Run Visual Tests (Update on main)
        run: |
          cd apps/web
          if [ "${{ github.ref }}" = "refs/heads/main" ] || [ "${{ github.ref }}" = "refs/heads/master" ]; then
            # Update baselines on main branch
            npm run test:update-snapshots
          else
            # Compare against baselines on PR
            npm run test:visual
          fi

      - name: Upload Visual Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: visual-test-results
          path: |
            apps/web/test-results/
            apps/web/tests/__screenshots__/
          retention-days: 14

  # Job 8: Accessibility Tests
  a11y-tests:
    name: Accessibility Tests
    runs-on: ubuntu-latest
    needs: [changes, build, playwright-deps]
    if: needs.changes.outputs.web-changed == 'true' || needs.changes.outputs.tests-changed == 'true'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Restore Node Modules Cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.npm
            apps/web/node_modules
            node_modules
          key: ${{ runner.os }}-node-${{ env.CACHE_VERSION }}-${{ hashFiles('package-lock.json', 'apps/web/package-lock.json') }}

      - name: Restore Playwright Cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/ms-playwright
            ~/Library/Caches/ms-playwright
            ~/AppData/Local/ms-playwright
          key: ${{ runner.os }}-playwright-${{ env.CACHE_VERSION }}-${{ env.PLAYWRIGHT_VERSION }}

      - name: Download Build Artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-output
          path: apps/web/dist

      - name: Run Accessibility Tests
        run: |
          cd apps/web
          npx playwright test tests/accessibility-comprehensive.spec.ts --project=chromium

  # Job 9: Performance Tests
  performance-tests:
    name: Performance Tests
    runs-on: ubuntu-latest
    needs: [changes, build]
    if: needs.changes.outputs.web-changed == 'true'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Restore Node Modules Cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.npm
            apps/web/node_modules
            node_modules
          key: ${{ runner.os }}-node-${{ env.CACHE_VERSION }}-${{ hashFiles('package-lock.json', 'apps/web/package-lock.json') }}

      - name: Download Build Artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-output
          path: apps/web/dist

      - name: Run Lighthouse CI
        uses: treosh/lighthouse-ci-action@v12
        with:
          configPath: './.github/lighthouserc.json'
          uploadArtifacts: true
          temporaryPublicStorage: true

  # Job 10: Deploy (Conditional)
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs:
      - changes
      - build
      - quality-check
      - unit-tests
      - e2e-tests
      - visual-tests
      - a11y-tests
      - performance-tests
    if: |
      github.ref == 'refs/heads/main' ||
      github.ref == 'refs/heads/master' ||
      (github.event_name == 'pull_request' && contains(github.event.pull_request.labels.*.name, 'deploy-preview'))
    environment:
      name: ${{ github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master' && 'production' || 'preview' }}
      url: ${{ steps.deploy.outputs.url }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download Build Artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-output
          path: apps/web/dist

      - name: Deploy to Vercel
        id: deploy
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          vercel-args: ${{ github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master' && '--prod' || '' }}
          working-directory: apps/web

  # Job 11: Test Summary and Notifications
  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs:
      - changes
      - build
      - quality-check
      - unit-tests
      - e2e-tests
      - visual-tests
      - a11y-tests
      - performance-tests
    if: always()
    steps:
      - name: Download All Test Results
        uses: actions/download-artifact@v4
        with:
          pattern: test-results-*
          merge-multiple: true
          path: all-test-results

      - name: Generate Test Summary
        uses: test-summary/action@v2
        with:
          paths: "all-test-results/results.json"
          show: "fail, error, pass, skip"

      - name: Notify Slack
        if: always()
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          channel: '#ci-cd'
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}
          fields: repo,message,commit,author,action,eventName,ref,workflow
          custom_payload: |
            {
              attachments: [{
                color: '${{ job.status }}' === 'success' ? 'good' : '${{ job.status }}' === 'failure' ? 'danger' : 'warning',
                fields: [{
                  title: 'Test Results',
                  value: `${{ needs.e2e-tests.result }}, ${{ needs.visual-tests.result }}, ${{ needs.a11y-tests.result }}`,
                  short: true
                }]
              }]
            }

  # Job 12: Rollback on Failure
  rollback:
    name: Rollback Deployment
    runs-on: ubuntu-latest
    needs: [deploy, test-summary]
    if: failure() && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get Previous Commit
        id: prev-commit
        run: |
          PREV_COMMIT=$(git rev-parse HEAD~1)
          echo "commit=$PREV_COMMIT" >> $GITHUB_OUTPUT

      - name: Rollback to Previous Version
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          vercel-args: '--prod --force'
          working-directory: apps/web
          github-deployment-environment: production
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Create Rollback Issue
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ðŸš¨ Production Rollback - ${new Date().toISOString()}`,
              body: `Automatic rollback triggered due to test failures in deployment.

              Rolled back from: ${context.sha}
              Rolled back to: ${{ steps.prev-commit.outputs.commit }}

              Please investigate the test failures before attempting another deployment.`,
              labels: ['rollback', 'production', 'urgent']
            })

  # Job 13: Cleanup
  cleanup:
    name: Cleanup Artifacts
    runs-on: ubuntu-latest
    needs: [deploy, test-summary]
    if: always()
    steps:
      - name: Delete Build Artifacts
        uses: geekyeggo/delete-artifact@v5
        with:
          name: |
            build-output
            test-results-*
            visual-test-results