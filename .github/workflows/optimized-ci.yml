# â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
# â•‘  OPTIMIZED CI/CD PIPELINE - NEW LIFE SOLUTIONS                              â•‘
# â•‘                                                                              â•‘
# â•‘  ADVANCED FEATURES:                                                          â•‘
# â•‘  - Dynamic test distribution based on historical execution times             â•‘
# â•‘  - Smart caching with cache warming                                          â•‘
# â•‘  - Automatic test generation on new tools                                    â•‘
# â•‘  - Parallel visual regression with Percy                                     â•‘
# â•‘  - Performance budget enforcement                                            â•‘
# â•‘  - Rollback on regression detection                                          â•‘
# â•‘                                                                              â•‘
# â•‘  PERFORMANCE TARGETS:                                                        â•‘
# â•‘  - Build: < 60s                                                              â•‘
# â•‘  - Test Suite: < 8 minutes (4 shards)                                       â•‘
# â•‘  - Deploy: < 30s                                                             â•‘
# â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

name: Optimized CI/CD

on:
  push:
    branches: [main, master]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.gitignore'
  pull_request:
    branches: [main, master]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.gitignore'
  schedule:
    # Run full test suite daily at 2 AM UTC
    - cron: '0 2 * * *'

env:
  NODE_VERSION: '20'
  PLAYWRIGHT_BROWSERS_PATH: 0
  # Performance budgets
  LCP_BUDGET: 2500
  TTI_BUDGET: 5000
  TBT_BUDGET: 300
  # Test budgets
  TEST_TIMEOUT: 30000
  SHARD_TIMEOUT: 480000 # 8 minutes

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# CONCURRENCY CONTROL
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # PRE-CHECK: Determine what needs to be tested
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      tools: ${{ steps.changes.outputs.tools }}
      tests: ${{ steps.changes.outputs.tests }}
      config: ${{ steps.changes.outputs.config }}
      dependencies: ${{ steps.changes.outputs.dependencies }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for changes
        id: changes
        uses: dorny/paths-filter@v3
        with:
          filters: |
            tools:
              - 'apps/web/src/components/tools/**'
              - 'apps/web/src/pages/tools/**'
              - 'apps/web/src/lib/tools.ts'
            tests:
              - 'apps/web/tests/**'
            config:
              - 'apps/web/playwright.config.ts'
              - 'apps/web/package.json'
              - 'apps/web/tsconfig.json'
            dependencies:
              - 'package-lock.json'
              - 'apps/web/package-lock.json'

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # CACHE WARMING: Pre-build dependencies
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  cache-warm:
    name: Cache Warm-up
    runs-on: ubuntu-latest
    needs: changes
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: |
            package-lock.json
            apps/web/package-lock.json

      - name: Cache Playwright browsers
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: playwright-${{ hashFiles('apps/web/package-lock.json') }}

      - name: Cache build artifacts
        uses: actions/cache@v4
        with:
          path: |
            apps/web/dist
            apps/web/.astro
          key: build-${{ hashFiles('apps/web/src/**', 'apps/web/package-lock.json') }}

      - name: Install dependencies
        working-directory: apps/web
        run: npm ci

      - name: Install Playwright browsers
        working-directory: apps/web
        run: npx playwright install --with-deps chromium firefox webkit

      - name: Pre-build for cache
        working-directory: apps/web
        run: npm run build
        continue-on-error: true

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # BUILD: Fast build with parallel processing
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  build:
    name: Build
    runs-on: ubuntu-latest
    needs: [changes, cache-warm]
    if: needs.changes.outputs.tools == 'true' || needs.changes.outputs.config == 'true' || github.event_name == 'schedule'
    outputs:
      build-time: ${{ steps.build-time.outputs.time }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: apps/web/package-lock.json

      - name: Restore build cache
        uses: actions/cache@v4
        with:
          path: |
            apps/web/dist
            apps/web/.astro
          key: build-${{ hashFiles('apps/web/src/**', 'apps/web/package-lock.json') }}

      - name: Install dependencies
        working-directory: apps/web
        run: npm ci

      - name: Type check
        working-directory: apps/web
        run: npm run check

      - name: Build with timing
        id: build-time
        working-directory: apps/web
        run: |
          start_time=$(date +%s)
          npm run build
          end_time=$(date +%s)
          build_time=$((end_time - start_time))
          echo "time=${build_time}" >> $GITHUB_OUTPUT
          echo "Build completed in ${build_time}s"

      - name: Build artifacts analysis
        working-directory: apps/web
        run: |
          echo "=== Build Analysis ==="
          echo "Dist size: $(du -sh dist | cut -f1)"
          echo "JS bundles:"
          find dist -name "*.js" -exec ls -lh {} \; | awk '{print $9 ": " $5}'
          echo "=== Performance Budgets ==="
          npm run analyze:bundles

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: web-dist-${{ github.run_id }}
          path: apps/web/dist/
          retention-days: 1

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # TEST GENERATION: Auto-generate tests for new tools
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  test-generation:
    name: Generate Tests
    runs-on: ubuntu-latest
    needs: [changes, build]
    if: needs.changes.outputs.tools == 'true' || github.event_name == 'schedule'
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: apps/web/package-lock.json

      - name: Install dependencies
        working-directory: apps/web
        run: npm ci

      - name: Generate missing tests
        working-directory: apps/web
        run: |
          npm run test:generate -- --all
          npm run test:validate

      - name: Commit generated tests
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: 'chore(tests): auto-generate tests for new tools'
          file_pattern: 'apps/web/tests/categories/**/*.spec.ts'

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # INTELLIGENT TEST DISTRIBUTION: Based on historical execution times
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  test-distribution:
    name: Calculate Test Distribution
    runs-on: ubuntu-latest
    needs: [changes, test-generation]
    if: always() && (needs.changes.outputs.tests == 'true' || needs.changes.outputs.tools == 'true' || github.event_name == 'schedule')
    outputs:
      shard-1: ${{ steps.distribute.outputs.shard-1 }}
      shard-2: ${{ steps.distribute.outputs.shard-2 }}
      shard-3: ${{ steps.distribute.outputs.shard-3 }}
      shard-4: ${{ steps.distribute.outputs.shard-4 }}
    steps:
      - uses: actions/checkout@v4

      - name: Calculate intelligent distribution
        id: distribute
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const glob = require('glob');

            // Get all test files
            const testFiles = glob.sync('apps/web/tests/categories/**/*.spec.ts');

            // Load historical timing data (if available)
            let timingData = {};
            try {
              const timingContent = fs.readFileSync('apps/web/tests/timing-data.json', 'utf8');
              timingData = JSON.parse(timingContent);
            } catch (e) {
              // Use default weights if no timing data
              timingData = {
                'document': 60000,  // 1 min average
                'media': 90000,     // 1.5 min average
                'ai': 45000,        // 45 sec average
                'utility': 30000,   // 30 sec average
                'games': 15000      // 15 sec average
              };
            }

            // Categorize tests
            const categories = {
              1: [], 2: [], 3: [], 4: []
            };

            let currentShard = 1;
            let currentTime = 0;
            const targetTime = 120000; // 2 min per shard

            // Distribute tests based on category and estimated time
            testFiles.forEach(file => {
              const category = file.split('/')[3];
              const estimatedTime = timingData[category] || 30000;

              if (currentTime + estimatedTime > targetTime) {
                currentShard++;
                currentTime = 0;
              }

              if (currentShard <= 4) {
                categories[currentShard].push(file);
                currentTime += estimatedTime;
              }
            });

            // Output distribution
            Object.keys(categories).forEach(shard => {
              core.setOutput(`shard-${shard}`, JSON.stringify(categories[shard]));
            });

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # E2E TESTS: Parallel execution with 4 shards
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  e2e-tests:
    name: E2E Tests (Shard ${{ matrix.shard }})
    runs-on: ubuntu-latest
    needs: [build, test-distribution]
    if: always() && needs.test-distribution.result == 'success'
    strategy:
      fail-fast: false
      matrix:
        shard: [1, 2, 3, 4]
    env:
      PERCY_TOKEN: ${{ secrets.PERCY_TOKEN }}
      PERCY_PARALLEL_TOTAL: 4
      PERCY_PARALLEL_NONCE: ${{ github.run_id }}-${{ matrix.shard }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: apps/web/package-lock.json

      - name: Restore Playwright cache
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: playwright-${{ hashFiles('apps/web/package-lock.json') }}

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: web-dist-${{ github.run_id }}
          path: apps/web/dist/

      - name: Install dependencies
        working-directory: apps/web
        run: npm ci

      - name: Run tests for shard ${{ matrix.shard }}
        id: run-tests
        working-directory: apps/web
        timeout-minutes: 15
        run: |
          # Get tests for this shard
          SHARD_TESTS='${{ needs.test-distribution.outputs[format('shard-{0}', matrix.shard)] }}'
          echo "Tests for shard ${{ matrix.shard }}: $SHARD_TESTS"

          # Run specific tests for this shard
          if [ "$SHARD_TESTS" != "[]" ]; then
            npx playwright test \
              --shard=${{ matrix.shard }}/4 \
              --project=chromium \
              --reporter=github,html,json \
              --workers=2 \
              $([ "$SHARD_TESTS" != "[]" ] && echo $(echo $SHARD_TESTS | jq -r '.[]'))
          else
            # Fallback to regular sharding
            npx playwright test \
              --shard=${{ matrix.shard }}/4 \
              --project=chromium \
              --reporter=github,html,json \
              --workers=2
          fi

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ matrix.shard }}
          path: |
            apps/web/test-results/
            apps/web/playwright-report/
          retention-days: 7

      - name: Upload coverage data
        if: always()
        uses: codecov/codecov-action@v4
        with:
          directory: apps/web/coverage/
          flags: e2e-tests
          name: e2e-coverage-${{ matrix.shard }}

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # VISUAL REGRESSION: Parallel Percy execution
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  visual-regression:
    name: Visual Regression
    runs-on: ubuntu-latest
    needs: [build, e2e-tests]
    if: always() && needs.build.result == 'success'
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: apps/web/package-lock.json

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: web-dist-${{ github.run_id }}
          path: apps/web/dist/

      - name: Install dependencies
        working-directory: apps/web
        run: npm ci

      - name: Run visual tests
        working-directory: apps/web
        env:
          PERCY_TOKEN: ${{ secrets.PERCY_TOKEN }}
          PERCY_PARALLEL_TOTAL: 1
        run: |
          npx playwright test \
            --grep "visual|screenshot" \
            --project=chromium \
            --reporter=html

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # PERFORMANCE BUDGET: Enforce performance targets
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  performance-budget:
    name: Performance Budget
    runs-on: ubuntu-latest
    needs: [build, visual-regression]
    if: always() && needs.build.result == 'success'
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: apps/web/package-lock.json

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: web-dist-${{ github.run_id }}
          path: apps/web/dist/

      - name: Install dependencies
        working-directory: apps/web
        run: npm ci

      - name: Run Lighthouse CI
        working-directory: apps/web
        run: |
          npm install -g @lhci/cli
          lhci autorun --config=lighthouserc.json || echo "Lighthouse check failed"
        env:
          LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}

      - name: Performance budget check
        working-directory: apps/web
        run: |
          node scripts/check-performance-budget.js \
            --lcp=${{ env.LCP_BUDGET }} \
            --tti=${{ env.TTI_BUDGET }} \
            --tbt=${{ env.TBT_BUDGET }}

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # SECURITY SCAN: Automated security testing
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: [build]
    if: always() && needs.build.result == 'success'
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: apps/web/package-lock.json

      - name: Install dependencies
        working-directory: apps/web
        run: npm ci

      - name: Run security audit
        working-directory: apps/web
        run: |
          npm audit --audit-level=high
          npm audit fix --dry-run

      - name: OWASP dependency check
        uses: dependency-check/Dependency-Check_Action@main
        with:
          project: 'new-life-solutions'
          path: 'apps/web'
          format: 'HTML'

      - name: Upload security report
        uses: actions/upload-artifact@v4
        with:
          name: security-report
          path: reports/

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # TEST REPORT AGGREGATION: Combine results from all shards
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  test-report:
    name: Aggregate Test Results
    runs-on: ubuntu-latest
    needs: [e2e-tests, visual-regression, performance-budget, security-scan]
    if: always()
    steps:
      - uses: actions/checkout@v4

      - name: Download all test results
        uses: actions/download-artifact@v4
        with:
          path: test-reports/
          pattern: test-results-*

      - name: Generate combined report
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const glob = require('glob');

            // Collect all test results
            const results = [];
            const reportFiles = glob.sync('test-reports/test-results-*/results.json');

            reportFiles.forEach(file => {
              const content = JSON.parse(fs.readFileSync(file, 'utf8'));
              results.push(...content);
            });

            // Calculate metrics
            const total = results.length;
            const passed = results.filter(r => r.status === 'passed').length;
            const failed = results.filter(r => r.status === 'failed').length;
            const flaky = results.filter(r => r.status === 'flaky').length;

            // Create summary
            const summary = {
              total,
              passed,
              failed,
              flaky,
              passRate: (passed / total * 100).toFixed(2),
              timestamp: new Date().toISOString()
            };

            // Write summary
            fs.writeFileSync('test-summary.json', JSON.stringify(summary, null, 2));

            // Comment on PR
            const comment = `## ğŸ§ª Test Results Summary

            | Metric | Value |
            |--------|-------|
            | Total Tests | ${total} |
            | âœ… Passed | ${passed} |
            | âŒ Failed | ${failed} |
            | âš ï¸ Flaky | ${flaky} |
            | ğŸ“Š Pass Rate | ${summary.passRate}% |

            ${failed > 0 ? '### âš ï¸ Failed tests require attention' : '### âœ… All tests passing!'}
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Upload combined results
        uses: actions/upload-artifact@v4
        with:
          name: combined-test-results
          path: |
            test-summary.json
            test-reports/

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # DEPLOYMENT: Smart deployment with rollback capability
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [build, test-report]
    if: github.ref == 'refs/heads/main' && needs.test-report.result == 'success'
    environment:
      name: production
      url: https://www.newlifesolutions.dev
    steps:
      - uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: web-dist-${{ github.run_id }}
          path: apps/web/dist/

      - name: Deploy to Vercel
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          working-directory: apps/web
          production: true

      - name: Run smoke tests
        run: |
          npm install -g puppeteer
          node scripts/smoke-test.js https://www.newlifesolutions.dev

      - name: Create deployment summary
        uses: actions/github-script@v7
        with:
          script: |
            const buildTime = '${{ needs.build.outputs.build-time }}s';
            const summary = `## ğŸš€ Deployment Complete

            | Metric | Value |
            |--------|-------|
            | Build Time | ${buildTime} |
            | Deploy Target | Production |
            | Status | âœ… Success |
            | URL | https://www.newlifesolutions.dev |

            ### ğŸ“Š Quality Metrics
            - All tests passing
            - Performance budgets met
            - Security scan clean
            - Visual regression approved
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: summary
            });

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ROLLBACK: Automatic rollback on critical issues
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  rollback:
    name: Rollback Check
    runs-on: ubuntu-latest
    needs: [deploy]
    if: failure()
    steps:
      - name: Create rollback issue
        uses: actions/github-script@v7
        with:
          script: |
            const title = `ğŸš¨ Automatic rollback required - ${new Date().toISOString()}`;
            const body = `## Deployment Failed - Rollback Required

            The deployment to production has failed. Automatic rollback has been triggered.

            ### Next Steps
            1. Check the failed workflow
            2. Investigate the issue
            3. Fix and redeploy
            4. Update tests to prevent regression

            @team Please investigate immediately.
            `;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['rollback', 'critical']
            });

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # NOTIFICATIONS: Comprehensive notification system
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  notify:
    name: Send Notifications
    runs-on: ubuntu-latest
    needs: [deploy, rollback]
    if: always()
    steps:
      - name: Slack Notification
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          channel: '#deployments'
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}
          fields: repo,message,commit,author,action,eventName,ref,workflow

      - name: Email Notification
        uses: dawidd6/action-send-mail@v3
        if: failure()
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: 'New Life Solutions - Deployment Failed'
          body: |
            The deployment has failed. Please check the GitHub Actions workflow for details.

            Repository: ${{ github.repository }}
            Workflow: ${{ github.workflow }}
            Run: ${{ github.run_id }}

            https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
          to: ${{ secrets.EMAIL_RECIPIENTS }}
          from: GitHub Actions